---
title: "GO_enrichment"
author: "Alfredo Rago"
date: "1/31/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(DESeq2)
library(biomaRt)
library(GOexpress)
library(here)
library(magrittr)
library(stringr)
library(GO.db)
library(fdrtool)
```

# Import read counts
```{r import_data}
culture_type_dataset <- 
  readRDS(file = here("results/deseq/DE_2D_vs_3D.Rdata")) 

culture_type_results <- results(culture_type_dataset)
metadata <- colData(culture_type_dataset)
```

# filter only expressed genes and re-apply variance stabilization
```{r filter_data}
culture_type_counts_filtered <- 
  culture_type_results %$% 
  is.na(padj) %>%
  not() %>% 
  which() %>% 
  culture_type_dataset[.,] %>% 
  vst()
```

# Normalize new gene set so each gene has the same absolute range
```{r normalize_data}
culture_type_counts_scaled <- 
  culture_type_counts_filtered %>% 
  assay() %>% 
  apply(X = ., MARGIN = 1, FUN = scale, center = TRUE, scale = TRUE) %>% 
  t() %>% 
  set_rownames(., assay(culture_type_counts_filtered) %>% row.names %>% str_extract(string = ., pattern = "^[[:alnum:]]*")) %>% 
  set_colnames(., assay(culture_type_counts_filtered) %>% colnames)
```


# save as a BioBase ExpressionSet object
including a gene-by-sample expres-sion matrix in theAssayDataslot, and a phenotypic information data-frame inthephenodateslot.  In the expression matrix, row names are identifiers of ex-pressed features, and column names are identifiers of the individual samples. Inthe phenotypic data-frame, row names are sample idenfifiers, column names aregrouping factors and phenotypic traits usable for statistical tests and visualisa-tion methods

```{r expression set}

culture_type_phenodata = 
  new("AnnotatedDataFrame", 
      data = as.data.frame(metadata), 
      varMetadata = colnames(metadata) %>% data.frame(labelDescription = ., row.names = .)
  )

expression_set <- 
  ExpressionSet(
    assayData = culture_type_counts_scaled,
    phenoData = culture_type_phenodata
  )
```

# Download gene_id to GO term table

```{r, go_table}
GO_table = getBM(
  attributes = c("ensembl_gene_id", "go_id"),
  mart = useEnsembl(biomart = 'ensembl', dataset = 'hsapiens_gene_ensembl')
  ) %>% 
  set_colnames(c("gene_id", "go_id"))

GO_ontologies = select(
  GO.db, 
  keytype = "GOID", 
  keys = unique(GO_table$go_id), 
  column = c("GOID", "DEFINITION", "ONTOLOGY")
) %>% 
  set_colnames(c("go_id", "name", "namespace")) %>% 
  dplyr::mutate(
    namespace = factor(x = namespace, levels = c("CC", "BP", "MF"), labels = c("cellular_component", "biological_process", "molecular_function"))
  )
```


# Run GOexpress random forest algorithm
```{r, random forest}
set.seed(42)

GO_results <- GO_analyse(
  eSet = expression_set,
  f = "treatment",
  GO_genes = GO_table,
  all_GO = GO_ontologies,
  method = "rf"
)

# Bootstrap tree results (1 sec each)
GO_pvalues = 
  GO_results %>% 
  subset_scores(total = 5) %>% 
  pValue_GO(N = 5)

GO_qvalues = 
  GO_pvalues %$% 
  GO %>% 
  dplyr::mutate(
    q.val = fdrtool(p.val)$qval
  ) %>% 
  dplyr::select(go_id, namespace_1003, total_count, data_count, q.val, p.val, ave_rank, ave_score, name_1006)

write.csv(x = GO_qvalues, file = here("results/GO_enrichment/GO_results.csv"))
```


